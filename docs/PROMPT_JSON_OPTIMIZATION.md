# Analysis Plan 提示词 JSON 格式优化

## 概述

本文档描述了针对 `analysis_plan` 提示词的 JSON 格式优化，确保 LLM 能够输出严格的 JSON 格式，提高解析成功率和数据质量。

## 优化目标

1. **确保严格的 JSON 格式输出**
2. **提高 JSON 解析成功率**
3. **减少格式错误和数据丢失**
4. **增强提示词的明确性和约束性**

## 优化内容

### 1. 系统提示词优化

#### 新增的关键要求

```markdown
CRITICAL JSON OUTPUT REQUIREMENTS:
- 你必须输出严格的JSON格式，不能包含任何其他文本
- JSON必须完全符合标准格式，所有字符串必须用双引号包围
- 不能包含注释、说明文字或其他非JSON内容
- 确保JSON可以被标准JSON解析器正确解析
- 输出必须是完整的JSON对象，以{开始，以}结束
```

#### 详细的字段说明

```markdown
字段说明：
- step_id: 步骤唯一标识符（字符串，只能包含字母、数字、下划线）
- step_name: 步骤名称（字符串）
- description: 步骤详细描述（字符串）
- method: 分析方法（字符串）
- dependencies: 依赖的步骤ID列表（数组，可以为空）
```

#### 格式约束

```markdown
关键要求：
- 步骤数量控制在3-6个之间
- 每个步骤都要有具体的分析目标
- 方法描述要具体且可操作
- 依赖关系要合理且避免循环依赖
- 确保JSON格式完全正确，可以被程序解析
- 所有字符串值不能包含换行符或特殊字符
- 数组和对象格式必须正确
```

### 2. 用户提示词优化

#### 增强的格式要求

```markdown
CRITICAL REQUIREMENTS:
1. 分析计划与主题分析结果高度相关
2. 步骤设计合理且可执行
3. 输出格式为严格的JSON，不能包含任何其他文本
4. 步骤数量适中（3-6个）
5. 每个步骤都有明确的目标和方法
6. 所有分析步骤都是当前可以通过LLM自动执行的，不包含任何需要未来人工参与或外部不可控条件的计划
7. JSON必须完全符合标准格式，所有字符串用双引号包围
8. 不能包含注释、说明文字或其他非JSON内容
9. 确保JSON可以被标准JSON解析器正确解析

请直接输出JSON格式的分析计划，不要包含任何其他文字说明。
```

## 优化效果

### 1. 提示词长度增加

- **系统提示词**: 从 ~800 字符增加到 1418 字符
- **用户提示词**: 从 ~200 字符增加到 320 字符

### 2. 格式要求强化

- ✅ 严格的JSON格式要求
- ✅ 禁止非JSON内容
- ✅ 双引号包围要求
- ✅ 无注释要求
- ✅ JSON解析器兼容性要求

### 3. 字段规范明确

- ✅ step_id 格式规范
- ✅ 所有必需字段说明
- ✅ 数据类型约束
- ✅ 依赖关系格式

## 测试验证

### 测试脚本

创建了两个测试脚本来验证优化效果：

1. `test_analysis_plan_json.py` - 验证提示词内容
2. `test_llm_json_output.py` - 模拟LLM响应验证

### 测试结果

```bash
=== 测试LLM JSON格式输出 ===
1. 提示词准备完成
   - 系统提示词长度: 1418
   - 用户提示词长度: 318

2. 模拟LLM响应
   - 响应长度: 823
   - 响应内容预览: { "steps": [ ...

3. JSON格式验证
   - 是否为有效JSON: 是
   - JSON结构验证:
     ✓ 包含steps字段: True
     ✓ steps是列表: True
     ✓ 步骤数量: 4
     ✓ 所有步骤字段验证通过

4. 提示词要求检查
   ✓ 严格的JSON格式: 是
   ✓ 不能包含其他文本: 是
   ✓ 双引号包围: 是
   ✓ 无注释: 是
   ✓ 可解析: 是

=== 测试结果 ===
✅ JSON格式验证通过
✅ 提示词优化成功
✅ LLM能够输出严格的JSON格式
```

## 预期改进

### 1. 解析成功率提升

- 减少 JSON 解析错误
- 提高数据完整性
- 降低格式不一致问题

### 2. 数据质量改善

- 标准化的字段格式
- 一致的依赖关系表示
- 清晰的方法描述

### 3. 系统稳定性增强

- 减少异常处理需求
- 提高工作流执行成功率
- 降低调试成本

## 实施建议

### 1. 监控和验证

- 定期检查 LLM 输出格式
- 验证 JSON 解析成功率
- 收集格式错误案例

### 2. 持续优化

- 根据实际使用情况调整
- 优化字段约束和格式要求
- 增强错误处理机制

### 3. 文档更新

- 更新相关技术文档
- 提供格式规范说明
- 建立最佳实践指南

## 总结

通过这次优化，`analysis_plan` 提示词现在能够：

1. **强制输出严格的 JSON 格式**
2. **提供详细的字段规范和约束**
3. **确保与 JSON 解析器的兼容性**
4. **提高数据质量和系统稳定性**

这些改进将显著提高 WhileVertexGroup 循环执行的成功率，确保分析步骤能够正确解析和执行。 