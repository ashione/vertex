# 多模态功能文档

## 概述

Vertex Workflow Chat 应用的多模态功能基于 OpenRouter 的 Gemini 2.5 Pro 模型，支持文本和图片的混合输入，为用户提供更丰富的AI交互体验。

## 功能特性

### 🎯 核心能力

- **智能图片分析**：准确识别和描述图片内容
- **文本+图片混合对话**：同时处理文本问题和图片内容
- **多种图片输入方式**：本地上传和网络URL
- **自动格式处理**：智能转换和验证图片格式
- **错误友好提示**：对不支持的内容提供解决方案

### 📸 支持的图片格式

- **文件格式**：JPG、PNG、GIF、WebP等常见格式
- **输入方式**：
  - 本地图片文件上传
  - 网络图片URL链接
  - Base64编码的图片数据

## 使用方法

### 基本操作

1. **上传本地图片**
   - 点击"上传图片"按钮
   - 选择本地图片文件
   - 系统自动转换为兼容格式

2. **粘贴图片URL**
   - 在"图片URL"输入框中粘贴网络图片链接
   - 确保链接可公开访问
   - 系统自动验证链接有效性

3. **混合输入**
   - 在文本框中输入问题
   - 同时上传图片或粘贴图片URL
   - 点击发送进行多模态对话

### 使用示例

#### 示例1：图片内容分析
```
用户输入：这张图片里有什么？
图片：上传一张风景照片
AI回复：这张图片展示了一幅美丽的自然风光，包含...
```

#### 示例2：图表数据分析
```
用户输入：分析这个图表的数据趋势
图片：上传一张数据图表
AI回复：根据图表显示，数据呈现上升趋势...
```

#### 示例3：产品识别
```
用户输入：这是什么产品？有什么特点？
图片：上传产品照片
AI回复：这是一个智能手机，具有以下特点...
```

## 技术实现

### 数据流程

```
用户上传图片 → Base64编码 → 多模态消息组装 → 
LLMVertex处理 → OpenAI格式消息 → OpenRouter API → 
Gemini模型分析 → 返回结果
```

### 关键技术点

1. **图片处理**
   ```python
   # 本地图片转Base64
   with open(image, "rb") as f:
       img_b64 = "data:image/png;base64," + base64.b64encode(f.read()).decode()
   ```

2. **多模态消息格式**
   ```python
   {
       "role": "user",
       "content": [
           {"type": "text", "text": "问题描述"},
           {"type": "image_url", "image_url": {"url": "base64_data"}}
       ]
   }
   ```

3. **智能URL验证**
   ```python
   if "discordapp.com" in url:
       # 检测不支持的图片源
       yield "⚠️ Discord图片链接可能不被支持"
   ```

## 配置要求

### 必需配置

1. **启用OpenRouter**
   ```yaml
   openrouter:
     enabled: true
     model-name: google/gemini-2.5-pro
   ```

2. **设置API密钥**
   ```bash
   export llm_openrouter_sk="sk-or-your-api-key"
   ```

3. **网络访问**
   - 确保能够访问 OpenRouter API
   - 图片URL需要可公开访问

### 推荐配置

```yaml
llm:
  openrouter:
    sk: ${llm.openrouter.sk:sk-or-your-key}
    enabled: true
    model-name: google/gemini-2.5-pro
  
  # 其他模型作为备选
  deepseek:
    sk: ${llm.deepseek.sk:sk-your-key}
    enabled: false
    model-name: deepseek-chat
```

## 最佳实践

### 图片质量建议

1. **分辨率**：建议使用清晰、分辨率适中的图片
2. **格式**：优先使用JPG或PNG格式
3. **大小**：单个图片建议不超过10MB
4. **内容**：确保图片内容清晰可见

### 提问技巧

1. **具体问题**：提出明确、具体的问题
2. **上下文结合**：将图片内容与文本问题结合
3. **分步分析**：复杂图片可以分步骤提问

### 错误处理

1. **不支持的图片源**
   - Discord、某些私有云存储的图片可能不被支持
   - 建议下载后重新上传或使用其他图片托管服务

2. **网络问题**
   - 确保图片URL可公开访问
   - 检查网络连接稳定性

3. **格式问题**
   - 使用常见图片格式
   - 避免损坏的图片文件

## 常见问题

### Q: 为什么Discord图片链接不被支持？
A: Discord的CDN有访问限制，OpenRouter API无法直接访问。建议下载图片后重新上传。

### Q: 支持哪些图片格式？
A: 支持JPG、PNG、GIF、WebP等常见格式，建议使用JPG或PNG格式。

### Q: 图片大小有限制吗？
A: 建议单个图片不超过10MB，过大的图片可能影响处理速度。

### Q: 可以同时上传多张图片吗？
A: 当前版本支持单张图片，多张图片功能正在开发中。

### Q: 多模态功能会影响文本对话吗？
A: 不会，多模态功能是增强功能，文本对话完全正常。

## 性能优化

### 图片处理优化

1. **压缩图片**：上传前适当压缩图片大小
2. **格式选择**：使用压缩率高的格式（如JPG）
3. **分辨率调整**：根据实际需要调整图片分辨率

### 网络优化

1. **CDN使用**：使用可靠的CDN服务托管图片
2. **链接稳定性**：确保图片链接长期有效
3. **备用方案**：准备本地图片作为备选

## 开发扩展

### 自定义图片处理

开发者可以扩展图片处理逻辑：

```python
def custom_image_processor(image_path):
    # 自定义图片预处理
    # 例如：添加水印、调整大小等
    return processed_image_path
```

### 多模态消息扩展

支持更多类型的多模态内容：

```python
# 未来可能支持的内容类型
{
    "type": "audio_url",
    "audio_url": {"url": "audio_data"}
},
{
    "type": "video_url", 
    "video_url": {"url": "video_data"}
}
```

## 总结

多模态功能为 Vertex Workflow Chat 应用带来了强大的图像理解能力，使用户能够通过图片和文本的组合与AI进行更自然、更丰富的交互。通过合理配置和正确使用，多模态功能将大大提升用户体验和应用价值。 