# 多模态功能文档

## 概述

Vertex Workflow Chat 应用的多模态功能基于 OpenRouter 的 Gemini 2.5 Pro 模型，支持文本和图片的混合输入，为用户提供更丰富的AI交互体验。

## 功能特性

### 🎯 核心能力

- **智能图片分析**：准确识别和描述图片内容
- **文本+图片混合对话**：同时处理文本问题和图片内容
- **多种图片输入方式**：本地上传和网络URL
- **自动格式处理**：智能转换和验证图片格式
- **错误友好提示**：对不支持的内容提供解决方案

### 📸 支持的图片格式

- **文件格式**：JPG、PNG、GIF、WebP等常见格式
- **输入方式**：
  - 本地图片文件上传
  - 网络图片URL链接
  - Base64编码的图片数据

## 使用方法

### 基本操作

1. **上传本地图片**
   - 点击"上传图片"按钮
   - 选择本地图片文件
   - 系统自动转换为兼容格式

2. **粘贴图片URL**
   - 在"图片URL"输入框中粘贴网络图片链接
   - 确保链接可公开访问
   - 系统自动验证链接有效性

3. **混合输入**
   - 在文本框中输入问题
   - 同时上传图片或粘贴图片URL
   - 点击发送进行多模态对话

### 使用示例

#### 示例1：图片内容分析
```
用户输入：这张图片里有什么？
图片：上传一张风景照片
AI回复：这张图片展示了一幅美丽的自然风光，包含...
```

#### 示例2：图表数据分析
```
用户输入：分析这个图表的数据趋势
图片：上传一张数据图表
AI回复：根据图表显示，数据呈现上升趋势...
```

#### 示例3：产品识别
```
用户输入：这是什么产品？有什么特点？
图片：上传产品照片
AI回复：这是一个智能手机，具有以下特点...
```

## 技术实现

### 数据流程

```
用户上传图片 → Base64编码 → 多模态消息组装 → 
LLMVertex处理 → OpenAI格式消息 → OpenRouter API → 
Gemini模型分析 → 返回结果
```

### 关键技术点

1. **图片处理**
   ```python
   # 本地图片转Base64
   with open(image, "rb") as f:
       img_b64 = "data:image/png;base64," + base64.b64encode(f.read()).decode()
   ```

2. **多模态消息格式**
   ```python
   {
       "role": "user",
       "content": [
           {"type": "text", "text": "问题描述"},
           {"type": "image_url", "image_url": {"url": "base64_data"}}
       ]
   }
   ```

3. **智能URL验证**
   ```python
   if "discordapp.com" in url:
       # 检测不支持的图片源
       yield "⚠️ Discord图片链接可能不被支持"
   ```

## 配置要求

### 必需配置

1. **启用OpenRouter**
   ```yaml
   openrouter:
     enabled: true
     model-name: google/gemini-2.5-pro
   ```

2. **设置API密钥**
   ```bash
   export llm_openrouter_sk="sk-or-your-api-key"
   ```

3. **网络访问**
   - 确保能够访问 OpenRouter API
   - 图片URL需要可公开访问

### 推荐配置

```yaml
llm:
  openrouter:
    sk: ${llm.openrouter.sk:sk-or-your-key}
    enabled: true
    models:
      - name: google/gemini-2.5-pro
        enabled: true
        default: true
  
  # 其他模型作为备选
  deepseek:
    sk: ${llm.deepseek.sk:sk-your-key}
    enabled: false
    models:
      - name: deepseek-chat
        enabled: true
        default: true
```

## 最佳实践

### 图片质量建议

1. **分辨率**：建议使用清晰、分辨率适中的图片
2. **格式**：优先使用JPG或PNG格式
3. **大小**：单个图片建议不超过10MB
4. **内容**：确保图片内容清晰可见

### 提问技巧

1. **具体问题**：提出明确、具体的问题
2. **上下文结合**：将图片内容与文本问题结合
3. **分步分析**：复杂图片可以分步骤提问

### 错误处理

1. **不支持的图片源**
   - Discord、某些私有云存储的图片可能不被支持
   - 建议下载后重新上传或使用其他图片托管服务

2. **网络问题**
   - 确保图片URL可公开访问
   - 检查网络连接稳定性

3. **格式问题**
   - 使用常见图片格式
   - 避免损坏的图片文件

## 常见问题

### Q: 为什么Discord图片链接不被支持？
A: Discord的CDN有访问限制，OpenRouter API无法直接访问。建议下载图片后重新上传。

### Q: 支持哪些图片格式？
A: 支持JPG、PNG、GIF、WebP等常见格式，建议使用JPG或PNG格式。

### Q: 图片大小有限制吗？
A: 建议单个图片不超过10MB，过大的图片可能影响处理速度。

### Q: 可以同时上传多张图片吗？
A: 当前版本支持单张图片，多张图片功能正在开发中。

### Q: 多模态功能会影响文本对话吗？
A: 不会，多模态功能是增强功能，文本对话完全正常。

## 性能优化

### 图片处理优化

1. **压缩图片**：上传前适当压缩图片大小
2. **格式选择**：使用压缩率高的格式（如JPG）
3. **分辨率调整**：根据实际需要调整图片分辨率

### 网络优化

1. **CDN加速**：使用图片CDN服务提高加载速度
2. **缓存策略**：合理设置图片缓存机制
3. **并发控制**：避免同时处理过多图片请求

## 使用示例

### 示例1：图片内容分析

**场景**：分析上传的图片内容

**操作步骤**：
1. 在聊天界面点击"上传图片"按钮
2. 选择一张图片文件
3. 在文本框中输入："这张图片里有什么？"
4. 点击发送

**预期结果**：
```
AI回复：这张图片展示了一个现代化的办公环境，包含：
- 一张整洁的办公桌
- 一台笔记本电脑
- 一杯咖啡
- 一些办公用品
整体氛围看起来专业而舒适。
```

### 示例2：图表数据分析

**场景**：分析数据图表

**操作步骤**：
1. 上传一张包含图表的图片
2. 输入问题："分析这个图表的数据趋势"
3. 发送消息

**预期结果**：
```
AI回复：根据图表显示，数据呈现以下趋势：
- 销售额在过去6个月中持续增长
- 增长率在3-4月达到峰值
- 5-6月增长趋于平稳
- 总体趋势向好，建议继续保持当前策略。
```

### 示例3：产品识别和描述

**场景**：识别产品并分析特点

**操作步骤**：
1. 上传产品照片
2. 输入："这是什么产品？有什么特点？"
3. 发送消息

**预期结果**：
```
AI回复：这是一个智能手机，具有以下特点：
- 大屏幕设计，提供良好的视觉体验
- 多摄像头系统，支持专业摄影
- 金属边框，质感优良
- 指纹识别功能
- 整体设计简洁现代
```

### 示例4：图片URL分析

**场景**：使用网络图片链接

**操作步骤**：
1. 在"图片URL"输入框中粘贴图片链接
2. 输入问题："分析这张图片的风格"
3. 发送消息

**预期结果**：
```
AI回复：这张图片采用了极简主义风格：
- 构图简洁，主体突出
- 色彩搭配和谐
- 光影效果自然
- 整体氛围宁静优雅
```

## 高级用法

### 混合对话示例

**场景**：结合文本和图片进行复杂分析

**操作步骤**：
1. 上传一张风景照片
2. 输入："这是一个旅游景点吗？如果是，推荐什么季节去？"
3. 发送消息

**预期结果**：
```
AI回复：根据图片分析，这确实是一个美丽的旅游景点：
- 看起来像是一个山区景点
- 植被茂密，环境优美
- 有清澈的水体和岩石景观

推荐季节：
- 春季：花开时节，景色宜人
- 秋季：色彩丰富，适合摄影
- 避开雨季，确保安全
```

### 技术文档分析

**场景**：分析技术图表或截图

**操作步骤**：
1. 上传技术文档截图
2. 输入："解释这个技术架构图"
3. 发送消息

**预期结果**：
```
AI回复：这是一个微服务架构图，包含以下组件：
- API网关：统一入口
- 用户服务：处理用户认证
- 订单服务：管理订单流程
- 支付服务：处理支付逻辑
- 数据库：数据存储层

架构特点：
- 服务解耦，独立部署
- 高可用性和可扩展性
- 支持不同技术栈
```

1. **CDN使用**：使用可靠的CDN服务托管图片
2. **链接稳定性**：确保图片链接长期有效
3. **备用方案**：准备本地图片作为备选

## 开发扩展

### 自定义图片处理

开发者可以扩展图片处理逻辑：

```python
def custom_image_processor(image_path):
    # 自定义图片预处理
    # 例如：添加水印、调整大小等
    return processed_image_path
```

### 多模态消息扩展

支持更多类型的多模态内容：

```python
# 未来可能支持的内容类型
{
    "type": "audio_url",
    "audio_url": {"url": "audio_data"}
},
{
    "type": "video_url", 
    "video_url": {"url": "video_data"}
}
```

## 总结

多模态功能为 Vertex Workflow Chat 应用带来了强大的图像理解能力，使用户能够通过图片和文本的组合与AI进行更自然、更丰富的交互。通过合理配置和正确使用，多模态功能将大大提升用户体验和应用价值。 