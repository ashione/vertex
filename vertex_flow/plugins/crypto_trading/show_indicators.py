#!/usr/bin/env python3
"""
Â±ïÁ§∫ÊåÅ‰ªìÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ
"""

import argparse
import traceback

from client import CryptoTradingClient
from indicators import TechnicalIndicators

from config import CryptoTradingConfig


def format_number(value):
    """Ê†ºÂºèÂåñÊï∞Â≠óÊòæÁ§∫"""
    if value is None:
        return "N/A"
    if isinstance(value, (int, float)):
        magnitude = abs(value)
        if magnitude >= 1000:
            return f"{value:,.2f}"
        if magnitude >= 1:
            return f"{value:.4f}"
        if magnitude >= 0.01:
            return f"{value:.6f}"
        return f"{value:.8f}"
    return str(value)


def safe_float(value):
    """Â∞ùËØïÂ∞Ü‰ªªÊÑèÂÄºËΩ¨Êç¢‰∏∫ÊµÆÁÇπÊï∞"""
    try:
        if value in (None, ""):
            return None
        number = float(value)
        return number
    except (TypeError, ValueError):
        return None


def get_signal_emoji(rsi, macd_histogram):
    """Ê†πÊçÆRSIÂíåMACDËé∑Âèñ‰ø°Âè∑Ë°®ÊÉÖ"""
    if rsi is None or macd_histogram is None:
        return "‚ö™"

    if rsi > 70 and macd_histogram < 0:
        return "üî¥"  # Ë∂Ö‰π∞‰∏îMACD‰∏ãÈôçÔºåÂçñÂá∫‰ø°Âè∑
    elif rsi < 30 and macd_histogram > 0:
        return "üü¢"  # Ë∂ÖÂçñ‰∏îMACD‰∏äÂçáÔºå‰π∞ÂÖ•‰ø°Âè∑
    elif rsi > 50 and macd_histogram > 0:
        return "üü°"  # ‰∏≠ÊÄßÂÅèÂ§ö
    else:
        return "‚ö™"  # ‰∏≠ÊÄß


def format_price(value):
    """Ê†ºÂºèÂåñ‰ª∑Ê†ºÔºåËã•Êó†Êï∞ÊçÆËøîÂõûN/A"""
    if value is None:
        return "N/A"
    return f"${format_number(value)}"


def display_indicators(symbol, indicators, position_info="", position_metrics=None):
    """ÊòæÁ§∫Âçï‰∏™Â∏ÅÁßçÁöÑÊäÄÊúØÊåáÊ†á"""
    print(f"\nüìä {symbol}")
    if position_info:
        print(f"   {position_info}")

    if position_metrics:
        entry_price = position_metrics.get("entry_price")
        leverage = position_metrics.get("leverage")
        support_level = position_metrics.get("support_level")
        resistance_level = position_metrics.get("resistance_level")
        pivot_level = position_metrics.get("pivot")
        volume_node = position_metrics.get("volume_node")

        leverage_display = "N/A"
        if leverage is not None:
            leverage_display = f"{format_number(leverage)}x"

        print(f"   üí∞ ‰π∞ÂÖ•ÊàêÊú¨: {format_price(entry_price)}")
        print(f"   üéØ Êù†ÊùÜÂÄçÊï∞: {leverage_display}")
        print(f"   üõ° ÊîØÊíë‰Ωç: {format_price(support_level)}")
        print(f"   üß± ÈòªÂäõ‰Ωç: {format_price(resistance_level)}")
        if pivot_level is not None:
            print(f"   üìç Êû¢ËΩ¥ÁÇπ: {format_price(pivot_level)}")
        if volume_node is not None:
            print(f"   üì¶ Êàê‰∫§ÈáèÂ≥∞ÂÄº: {format_price(volume_node)}")

    if "error" in indicators:
        print(f"   ‚ùå ËÆ°ÁÆóÊåáÊ†áÂá∫Èîô: {indicators['error']}")
        return

    current_price = indicators.get("current_price")
    if current_price:
        print(f"   ÂΩìÂâç‰ª∑Ê†º: ${format_number(current_price)}")

    # RSI
    rsi = indicators.get("rsi")
    if rsi is not None:
        rsi_status = "Ë∂Ö‰π∞" if rsi > 70 else "Ë∂ÖÂçñ" if rsi < 30 else "Ê≠£Â∏∏"
        print(f"   üìà RSI(14): {format_number(rsi)} ({rsi_status})")

    # MACD
    macd = indicators.get("macd")
    if macd and isinstance(macd, dict):
        macd_line = macd.get("macd")
        signal_line = macd.get("signal")
        histogram = macd.get("histogram")

        if all(v is not None for v in [macd_line, signal_line, histogram]):
            trend = "‰∏äÂçá" if histogram > 0 else "‰∏ãÈôç"
            print(
                f"   üìä MACD: {format_number(macd_line)} | ‰ø°Âè∑: {format_number(signal_line)} | Êü±Áä∂: {format_number(histogram)} ({trend})"
            )

    # ÁßªÂä®Âπ≥ÂùáÁ∫ø
    sma_20 = indicators.get("sma_20")
    ema_12 = indicators.get("ema_12")
    if sma_20 is not None:
        print(f"   üìâ SMA(20): {format_number(sma_20)}")
    if ema_12 is not None:
        print(f"   üìà EMA(12): {format_number(ema_12)}")

    # Â∏ÉÊûóÂ∏¶
    bb = indicators.get("bollinger_bands")
    if bb and isinstance(bb, dict):
        upper = bb.get("upper")
        middle = bb.get("middle")
        lower = bb.get("lower")
        if all(v is not None for v in [upper, middle, lower]):
            print(
                f"   üéØ Â∏ÉÊûóÂ∏¶: ‰∏äËΩ® {format_number(upper)} | ‰∏≠ËΩ® {format_number(middle)} | ‰∏ãËΩ® {format_number(lower)}"
            )

    # ‰∫§Êòì‰ø°Âè∑
    signal_emoji = get_signal_emoji(rsi, macd.get("histogram") if macd else None)
    print(f"   {signal_emoji} ÁªºÂêà‰ø°Âè∑")


def parse_args():
    parser = argparse.ArgumentParser(description="Â±ïÁ§∫Áé∞Ë¥ßÊàñÂêàÁ∫¶ÁöÑÊäÄÊúØÊåáÊ†á")
    parser.add_argument(
        "-m",
        "--market",
        choices=["spot", "futures", "both"],
        default="both",
        help="ÈÄâÊã©Â±ïÁ§∫Áé∞Ë¥ß„ÄÅÂêàÁ∫¶ÊàñÂÖ®ÈÉ® (ÈªòËÆ§: both)",
    )
    return parser.parse_args()


def main():
    args = parse_args()
    show_spot = args.market in {"spot", "both"}
    show_futures = args.market in {"futures", "both"}

    try:
        # ÂàùÂßãÂåñÂÆ¢Êà∑Á´Ø
        config = CryptoTradingConfig()
        client = CryptoTradingClient(config)

        if show_spot:
            print("üî∏ Áé∞Ë¥ßÊåÅ‰ªìÊäÄÊúØÊåáÊ†á")
            print("=" * 40)

            # Ëé∑ÂèñÁé∞Ë¥ßÊåÅ‰ªì
            spot_positions = client.get_spot_positions("okx")

            if spot_positions.get("success") and spot_positions.get("data"):
                for position in spot_positions["data"]:
                    currency = position["currency"]
                    balance = position["balance"]

                    # Ë∑≥ËøáUSDTÂíå‰ΩôÈ¢ù‰∏∫0ÁöÑÂ∏ÅÁßç
                    if currency != "USDT" and float(balance) > 0:
                        symbol = f"{currency}-USDT"
                        position_info = f"ÊåÅ‰ªìÈáè: {format_number(float(balance))} {currency}"

                        try:
                            # Ëé∑ÂèñKÁ∫øÊï∞ÊçÆ
                            klines = client.get_klines("okx", symbol, "1h", 100)
                            if klines and len(klines) > 26:  # Á°Æ‰øùÊúâË∂≥Â§üÊï∞ÊçÆËÆ°ÁÆóMACD
                                indicators = TechnicalIndicators.calculate_all_indicators(klines)

                                support_level = None
                                resistance_level = None
                                pivot_level = None
                                volume_node = None
                                support_data = indicators.get("support_resistance")
                                if support_data:
                                    support_levels = support_data.get("support") or []
                                    if support_levels:
                                        support_level = support_levels[-1]
                                    resistance_levels = support_data.get("resistance") or []
                                    if resistance_levels:
                                        resistance_level = resistance_levels[0]
                                    pivot_level = support_data.get("pivot")
                                    volume_nodes = support_data.get("volume_nodes") or []
                                    if volume_nodes:
                                        volume_node = volume_nodes[0]

                                entry_price = None
                                for key in ("avg_price", "avgPrice", "avg_px", "average_price"):
                                    candidate = safe_float(position.get(key))
                                    if candidate:
                                        entry_price = candidate
                                        break

                                metrics = {
                                    "entry_price": entry_price,
                                    "leverage": 1,
                                    "support_level": support_level,
                                    "resistance_level": resistance_level,
                                    "pivot": pivot_level,
                                    "volume_node": volume_node,
                                }

                                display_indicators(symbol, indicators, position_info, metrics)
                            else:
                                print(f"\nüìä {symbol}")
                                print(f"   {position_info}")
                                print(f"   ‚ùå KÁ∫øÊï∞ÊçÆ‰∏çË∂≥ (ÈúÄË¶ÅËá≥Â∞ë26Êù°)")
                        except Exception as e:
                            print(f"\nüìä {symbol}")
                            print(f"   {position_info}")
                            print(f"   ‚ùå Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•: {str(e)}")
            else:
                print("   ‚ùå Êó†Ê≥ïËé∑ÂèñÁé∞Ë¥ßÊåÅ‰ªìÊï∞ÊçÆ")

        if show_futures:
            if show_spot:
                print()
            print("üî∏ ÂêàÁ∫¶ÊåÅ‰ªìÊäÄÊúØÊåáÊ†á")
            print("=" * 40)

            # Ëé∑ÂèñÂêàÁ∫¶ÊåÅ‰ªì
            futures_positions = client.get_futures_positions("okx")

            if futures_positions.get("success") and futures_positions.get("data"):
                for position in futures_positions["data"]:
                    symbol = position["symbol"]
                    size = position["size"]
                    side = position["side"]
                    unrealized_pnl = position.get("unrealized_pnl", 0)

                    if float(size) != 0:
                        position_info = f"ÊñπÂêë: {side}, Êï∞Èáè: {format_number(float(size))}"
                        if unrealized_pnl:
                            pnl_str = f"${format_number(float(unrealized_pnl))}"
                            position_info += f"\n   Êú™ÂÆûÁé∞Áõà‰∫è: {pnl_str}"

                        try:
                            # Ëé∑ÂèñKÁ∫øÊï∞ÊçÆ
                            klines = client.get_klines("okx", symbol, "1h", 100)
                            if klines and len(klines) > 26:
                                indicators = TechnicalIndicators.calculate_all_indicators(klines)

                                support_level = None
                                resistance_level = None
                                pivot_level = None
                                volume_node = None
                                support_data = indicators.get("support_resistance")
                                if support_data:
                                    support_levels = support_data.get("support") or []
                                    if support_levels:
                                        support_level = support_levels[-1]
                                    resistance_levels = support_data.get("resistance") or []
                                    if resistance_levels:
                                        resistance_level = resistance_levels[0]
                                    pivot_level = support_data.get("pivot")
                                    volume_nodes = support_data.get("volume_nodes") or []
                                    if volume_nodes:
                                        volume_node = volume_nodes[0]

                                entry_price = safe_float(position.get("avg_price"))
                                if entry_price is None:
                                    entry_price = safe_float(position.get("avg_price_str"))

                                leverage = safe_float(position.get("leverage"))
                                if not leverage:
                                    notional = abs(position.get("notional", 0))
                                    margin = position.get("margin", 0)
                                    if margin:
                                        leverage = notional / margin

                                metrics = {
                                    "entry_price": entry_price,
                                    "leverage": leverage,
                                    "support_level": support_level,
                                    "resistance_level": resistance_level,
                                    "pivot": pivot_level,
                                    "volume_node": volume_node,
                                }

                                display_indicators(symbol, indicators, position_info, metrics)
                            else:
                                print(f"\nüìä {symbol}")
                                print(f"   {position_info}")
                                print(f"   ‚ùå KÁ∫øÊï∞ÊçÆ‰∏çË∂≥ (ÈúÄË¶ÅËá≥Â∞ë26Êù°)")
                        except Exception as e:
                            print(f"\nüìä {symbol}")
                            print(f"   {position_info}")
                            print(f"   ‚ùå Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•: {str(e)}")
            else:
                print("   ‚ùå Êó†Ê≥ïËé∑ÂèñÂêàÁ∫¶ÊåÅ‰ªìÊï∞ÊçÆ")

        print("\n" + "=" * 60)
        print("Êä•ÂëäÁîüÊàêÂÆåÊàê ‚úÖ")
        print("=" * 60)

    except Exception as e:
        print(f"‚ùå Á®ãÂ∫èÊâßË°åÂá∫Èîô: {str(e)}")
        traceback.print_exc()


if __name__ == "__main__":
    main()
