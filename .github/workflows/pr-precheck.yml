name: PR Precheck

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  precheck:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11, 3.12]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装uv（如果可用）
        if ! command -v uv &> /dev/null; then
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
        fi
        
        # 使用uv安装项目依赖（推荐）
        if command -v uv &> /dev/null; then
          uv pip install -e .
          uv pip install -e ".[dev]"
        else
          # 回退到pip安装
          pip install -r requirements.txt
          pip install -e .
        fi
    
    - name: Check Python code formatting
      run: |
        bash scripts/precommit.sh
        # 检查是否有格式化后的diff
        if ! git diff --exit-code -- '*.py'; then
          echo "❌ 代码格式不规范，请先在本地运行 bash scripts/precommit.sh 并提交格式化后的代码。"
          exit 1
        fi
    
    - name: 配置文件脱敏检查
      run: |
        echo "🔧 检查配置文件是否已脱敏..."
        
        # 运行脱敏脚本检查
        if [ -f "scripts/sanitize_config.py" ]; then
          python3 scripts/sanitize_config.py
          
          # 检查是否有未脱敏的文件 - 检查两个配置目录
          CONFIG_CHANGED=false
          
          # 检查根目录config/（如果存在）
          if [ -d "config" ] && ! git diff --quiet config/; then
            echo "✗ 发现未脱敏的配置文件 (config/):"
            git diff config/
            CONFIG_CHANGED=true
          fi
          
          # 检查vertex_flow/config/
          if [ -d "vertex_flow/config" ] && ! git diff --quiet vertex_flow/config/; then
            echo "✗ 发现未脱敏的配置文件 (vertex_flow/config/):"
            git diff vertex_flow/config/
            CONFIG_CHANGED=true
          fi
          
          if [ "$CONFIG_CHANGED" = true ]; then
            echo "请运行 'python3 scripts/sanitize_config.py' 进行脱敏处理"
            exit 1
          else
            echo "✓ 配置文件已正确脱敏"
          fi
        else
          echo "⚠ 脱敏脚本不存在，跳过脱敏检查"
        fi
    
    - name: Check for sensitive information
      run: |
        echo "🔍 Checking for sensitive information in PR..."
        
        # 检查常见的敏感信息模式
        SENSITIVE_PATTERNS=(
          "sk-[a-zA-Z0-9]{32,}"
          "sk-or-[a-zA-Z0-9-]{32,}"
          "api[_-]?key[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "secret[_-]?key[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "access[_-]?token[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "password[\s]*[:=][\s]*['\"][^'\"]{8,}['\"]?"
          "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}.*password"
          "mongodb://[^\s]+"
          "mysql://[^\s]+"
          "postgres://[^\s]+"
          "redis://[^\s]+"
        )
        
        FOUND_SENSITIVE=false
        
        # 获取PR中修改的文件（排除流水线目录）
        git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -v '^\.github/' > changed_files.txt || true
        
        echo "📁 Files changed in this PR:"
        cat changed_files.txt
        echo ""
        
        # 检查每个修改的文件
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "🔍 Checking file: $file"
            
            # 获取文件的新增内容
            git diff origin/${{ github.base_ref }}..HEAD -- "$file" | grep "^+" > temp_additions.txt
            
            # 检查每个敏感信息模式
            for pattern in "${SENSITIVE_PATTERNS[@]}"; do
              if grep -iE "$pattern" temp_additions.txt > /dev/null 2>&1; then
                echo "❌ 发现可能的敏感信息在文件 $file:"
                grep -iE "$pattern" temp_additions.txt | head -5
                echo ""
                FOUND_SENSITIVE=true
              fi
            done
            
            rm -f temp_additions.txt
          fi
        done < changed_files.txt
        
        rm -f changed_files.txt
        
        if [ "$FOUND_SENSITIVE" = true ]; then
          echo "❌ 检测到可能的敏感信息泄露！请检查并移除API密钥、密码等敏感信息。"
          echo "💡 建议使用环境变量或配置文件来管理敏感信息。"
          exit 1
        else
          echo "✅ 未发现敏感信息泄露。"
        fi
    
    - name: Run Unit Tests
      run: |
        echo "🧪 运行单元测试..."
        
        # 检查测试脚本是否存在
        if [ -f "scripts/run_tests.sh" ]; then
          chmod +x scripts/run_tests.sh
          ./scripts/run_tests.sh
        else
          echo "⚠️ 测试脚本不存在，跳过单元测试"
          echo "💡 建议创建 scripts/run_tests.sh 脚本来运行测试"
        fi
    
    - name: Summary
      if: success()
      run: |
        echo "🎉 所有预检查项目都已通过！"
        echo "✅ 敏感信息检查: 通过"
        echo "✅ Python语法检查: 通过"
        echo "✅ Import * 禁用检查: 通过"
        echo "✅ 代码风格检查: 通过"
        echo "✅ Import排序检查: 通过"
        echo "✅ 代码格式检查: 通过"
        echo "✅ 单元测试: 通过"
        echo ""
        echo "🚀 PR已准备好进行合并审查！"