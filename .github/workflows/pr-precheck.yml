name: PR Precheck

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  precheck:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11, 3.12]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…uvï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if ! command -v uv &> /dev/null; then
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
        fi
        
        # ä½¿ç”¨uvå®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆæ¨èï¼‰
        if command -v uv &> /dev/null; then
          uv pip install -e .
          uv pip install -e ".[dev]"
        else
          # å›é€€åˆ°pipå®‰è£…
          pip install -r requirements.txt
          pip install -e .
        fi
    
    - name: Check Python code formatting
      run: |
        bash scripts/precommit.sh
        # æ£€æŸ¥æ˜¯å¦æœ‰æ ¼å¼åŒ–åçš„diff
        if ! git diff --exit-code -- '*.py'; then
          echo "âŒ ä»£ç æ ¼å¼ä¸è§„èŒƒï¼Œè¯·å…ˆåœ¨æœ¬åœ°è¿è¡Œ bash scripts/precommit.sh å¹¶æäº¤æ ¼å¼åŒ–åçš„ä»£ç ã€‚"
          exit 1
        fi
    
    - name: é…ç½®æ–‡ä»¶è„±æ•æ£€æŸ¥
      run: |
        echo "ğŸ”§ æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å·²è„±æ•..."
        
        # è¿è¡Œè„±æ•è„šæœ¬æ£€æŸ¥
        if [ -f "scripts/sanitize_config.py" ]; then
          python3 scripts/sanitize_config.py
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªè„±æ•çš„æ–‡ä»¶ - æ£€æŸ¥ä¸¤ä¸ªé…ç½®ç›®å½•
          CONFIG_CHANGED=false
          
          # æ£€æŸ¥æ ¹ç›®å½•config/ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "config" ] && ! git diff --quiet config/; then
            echo "âœ— å‘ç°æœªè„±æ•çš„é…ç½®æ–‡ä»¶ (config/):"
            git diff config/
            CONFIG_CHANGED=true
          fi
          
          # æ£€æŸ¥vertex_flow/config/
          if [ -d "vertex_flow/config" ] && ! git diff --quiet vertex_flow/config/; then
            echo "âœ— å‘ç°æœªè„±æ•çš„é…ç½®æ–‡ä»¶ (vertex_flow/config/):"
            git diff vertex_flow/config/
            CONFIG_CHANGED=true
          fi
          
          if [ "$CONFIG_CHANGED" = true ]; then
            echo "è¯·è¿è¡Œ 'python3 scripts/sanitize_config.py' è¿›è¡Œè„±æ•å¤„ç†"
            exit 1
          else
            echo "âœ“ é…ç½®æ–‡ä»¶å·²æ­£ç¡®è„±æ•"
          fi
        else
          echo "âš  è„±æ•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡è„±æ•æ£€æŸ¥"
        fi
    
    - name: Check for sensitive information
      run: |
        echo "ğŸ” Checking for sensitive information in PR..."
        
        # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
        SENSITIVE_PATTERNS=(
          "sk-[a-zA-Z0-9]{32,}"
          "sk-or-[a-zA-Z0-9-]{32,}"
          "api[_-]?key[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "secret[_-]?key[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "access[_-]?token[\s]*[:=][\s]*['\"][a-zA-Z0-9]{16,}['\"]?"
          "password[\s]*[:=][\s]*['\"][^'\"]{8,}['\"]?"
          "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}.*password"
          "mongodb://[^\s]+"
          "mysql://[^\s]+"
          "postgres://[^\s]+"
          "redis://[^\s]+"
        )
        
        FOUND_SENSITIVE=false
        
        # è·å–PRä¸­ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆæ’é™¤æµæ°´çº¿ç›®å½•ï¼‰
        git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -v '^\.github/' > changed_files.txt || true
        
        echo "ğŸ“ Files changed in this PR:"
        cat changed_files.txt
        echo ""
        
        # æ£€æŸ¥æ¯ä¸ªä¿®æ”¹çš„æ–‡ä»¶
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "ğŸ” Checking file: $file"
            
            # è·å–æ–‡ä»¶çš„æ–°å¢å†…å®¹
            git diff origin/${{ github.base_ref }}..HEAD -- "$file" | grep "^+" > temp_additions.txt
            
            # æ£€æŸ¥æ¯ä¸ªæ•æ„Ÿä¿¡æ¯æ¨¡å¼
            for pattern in "${SENSITIVE_PATTERNS[@]}"; do
              if grep -iE "$pattern" temp_additions.txt > /dev/null 2>&1; then
                echo "âŒ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯åœ¨æ–‡ä»¶ $file:"
                grep -iE "$pattern" temp_additions.txt | head -5
                echo ""
                FOUND_SENSITIVE=true
              fi
            done
            
            rm -f temp_additions.txt
          fi
        done < changed_files.txt
        
        rm -f changed_files.txt
        
        if [ "$FOUND_SENSITIVE" = true ]; then
          echo "âŒ æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼è¯·æ£€æŸ¥å¹¶ç§»é™¤APIå¯†é’¥ã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ã€‚"
          echo "ğŸ’¡ å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶æ¥ç®¡ç†æ•æ„Ÿä¿¡æ¯ã€‚"
          exit 1
        else
          echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€‚"
        fi
    
    - name: Run Unit Tests
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        
        # æ£€æŸ¥æµ‹è¯•è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ -f "scripts/run_tests.sh" ]; then
          chmod +x scripts/run_tests.sh
          ./scripts/run_tests.sh
        else
          echo "âš ï¸ æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å•å…ƒæµ‹è¯•"
          echo "ğŸ’¡ å»ºè®®åˆ›å»º scripts/run_tests.sh è„šæœ¬æ¥è¿è¡Œæµ‹è¯•"
        fi
    
    - name: Summary
      if: success()
      run: |
        echo "ğŸ‰ æ‰€æœ‰é¢„æ£€æŸ¥é¡¹ç›®éƒ½å·²é€šè¿‡ï¼"
        echo "âœ… æ•æ„Ÿä¿¡æ¯æ£€æŸ¥: é€šè¿‡"
        echo "âœ… Pythonè¯­æ³•æ£€æŸ¥: é€šè¿‡"
        echo "âœ… Import * ç¦ç”¨æ£€æŸ¥: é€šè¿‡"
        echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥: é€šè¿‡"
        echo "âœ… Importæ’åºæ£€æŸ¥: é€šè¿‡"
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥: é€šè¿‡"
        echo "âœ… å•å…ƒæµ‹è¯•: é€šè¿‡"
        echo ""
        echo "ğŸš€ PRå·²å‡†å¤‡å¥½è¿›è¡Œåˆå¹¶å®¡æŸ¥ï¼"